#!/usr/bin/env python3"""AI Guard - Test File AuditorScans test files for secrets, bad practices, and technical debt"""import osimport reimport sysimport jsonfrom pathlib import Pathfrom typing import List, Dict, Tuplefrom datetime import datetimeclass TestAuditor:    def __init__(self):        self.issues = []        self.warnings = []        # Patterns to detect        self.secret_patterns = [            (r'password\s*[=:]\s*["\']([^"\']+)["\']', 'Hardcoded password'),            (r'api[_-]?key\s*[=:]\s*["\']([^"\']+)["\']', 'API key'),            (r'secret\s*[=:]\s*["\']([^"\']+)["\']', 'Secret token'),            (r'token\s*[=:]\s*["\']([^"\']+)["\']', 'Auth token'),            (r'bearer\s+[A-Za-z0-9\-._~+/]+=*', 'Bearer token'),            (r'@(gmail|yahoo|outlook|hotmail)\.com', 'Email address'),            (r'Production@\d{4}!', 'Production password pattern'),        ]        self.bad_practices = [            (r'waitForTimeout\s*\(', 'waitForTimeout usage (flaky tests)'),            (r'\.skip\s*\(', 'Skipped test'),            (r'\.only\s*\(', 'Focused test (.only)'),            (r'console\.(log|debug)\s*\(', 'Console log statement'),            (r'TODO:', 'TODO comment'),            (r'FIXME:', 'FIXME comment'),            (r'@ts-ignore', 'TypeScript ignore directive'),            (r'any\s+as\s+', 'Type assertion to any'),            (r'setTimeout\s*\(', 'setTimeout usage'),            (r'setInterval\s*\(', 'setInterval usage'),        ]        self.playwright_antipatterns = [            (r'page\.waitForTimeout\s*\(\s*\d+', 'Hard-coded wait (use waitFor instead)'),            (r'await\s+page\.goto\([^)]*\)[^;]*;\s*await\s+page\.waitForTimeout', 'goto + waitForTimeout (use waitForLoadState)'),            (r'\.first\(\)\.click\(\)', 'Using .first() without verification'),            (r'\.nth\(\d+\)\.click\(\)', 'Using .nth() without verification'),        ]    def scan_file(self, filepath: str) -> Dict:        """Scan a single file for issues"""        result = {            'file': filepath,            'secrets': [],            'bad_practices': [],            'playwright_issues': [],            'line_count': 0        }        try:            with open(filepath, 'r', encoding='utf-8') as f:                lines = f.readlines()                result['line_count'] = len(lines)                for line_num, line in enumerate(lines, 1):                    # Check for secrets                    for pattern, description in self.secret_patterns:                        matches = re.finditer(pattern, line, re.IGNORECASE)                        for match in matches:                            result['secrets'].append({                                'line': line_num,                                'type': description,                                'content': line.strip(),                                'match': match.group(0)                            })                    # Check for bad practices                    for pattern, description in self.bad_practices:                        if re.search(pattern, line, re.IGNORECASE):                            result['bad_practices'].append({                                'line': line_num,                                'type': description,                                'content': line.strip()                            })                    # Check for Playwright antipatterns                    for pattern, description in self.playwright_antipatterns:                        if re.search(pattern, line, re.IGNORECASE):                            result['playwright_issues'].append({                                'line': line_num,                                'type': description,                                'content': line.strip()                            })        except Exception as e:            result['error'] = str(e)        return result    def scan_directory(self, directory: str, extensions: List[str] = None) -> List[Dict]:        """Recursively scan directory for test files"""        if extensions is None:            extensions = ['.ts', '.js', '.spec.ts', '.test.ts']        results = []        path = Path(directory)        if not path.exists():            print(f"âŒ Directory not found: {directory}")            return results        for file_path in path.rglob('*'):            if file_path.is_file() and any(str(file_path).endswith(ext) for ext in extensions):                # Skip node_modules and dist directories                if 'node_modules' in str(file_path) or 'dist' in str(file_path):                    continue                result = self.scan_file(str(file_path))                if result['secrets'] or result['bad_practices'] or result['playwright_issues']:                    results.append(result)        return results    def save_results(self, results: List[Dict], output_dir: str = 'audit') -> str:        """Save audit results to JSON and Markdown files"""        # Create audit directory if it doesn't exist        Path(output_dir).mkdir(exist_ok=True)        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')        # Calculate summary statistics        total_files = len(results)        total_secrets = sum(len(r['secrets']) for r in results)        total_bad_practices = sum(len(r['bad_practices']) for r in results)        total_playwright_issues = sum(len(r['playwright_issues']) for r in results)        total_issues = total_secrets + total_bad_practices + total_playwright_issues        # Save JSON report        json_file = f"{output_dir}/audit_report_{timestamp}.json"        report_data = {            'timestamp': datetime.now().isoformat(),            'summary': {                'total_files_scanned': total_files,                'total_secrets': total_secrets,                'total_bad_practices': total_bad_practices,                'total_playwright_issues': total_playwright_issues,                'total_issues': total_issues            },            'results': results        }        with open(json_file, 'w', encoding='utf-8') as f:            json.dump(report_data, f, indent=2)        # Save Markdown report        md_file = f"{output_dir}/audit_report_{timestamp}.md"        with open(md_file, 'w', encoding='utf-8') as f:            f.write(f"# AI Guard Audit Report\n\n")            f.write(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")            f.write(f"---\n\n")            f.write(f"## ğŸ“Š Summary\n\n")            f.write(f"| Metric | Count |\n")            f.write(f"|--------|-------|\n")            f.write(f"| Files Scanned | {total_files} |\n")            f.write(f"| ğŸš¨ Critical Secrets | {total_secrets} |\n")            f.write(f"| âš ï¸ Playwright Antipatterns | {total_playwright_issues} |\n")            f.write(f"| ğŸ“‹ Bad Practices | {total_bad_practices} |\n")            f.write(f"| **Total Issues** | **{total_issues}** |\n\n")            if total_issues == 0:                f.write(f"âœ… **Status:** All Clear - No issues found!\n\n")            elif total_secrets > 0:                f.write(f"âŒ **Status:** FAILED - Critical secrets detected!\n\n")            else:                f.write(f"âš ï¸ **Status:** WARNINGS - Consider addressing these issues\n\n")            f.write(f"---\n\n")            # Detail each file            if results:                f.write(f"## ğŸ” Detailed Findings\n\n")                for result in results:                    f.write(f"### ğŸ“„ {result['file']}\n\n")                    f.write(f"**Lines:** {result['line_count']}\n\n")                    if result['secrets']:                        f.write(f"#### ğŸš¨ Critical Secrets ({len(result['secrets'])})\n\n")                        for issue in result['secrets']:                            f.write(f"- **Line {issue['line']}:** {issue['type']}\n")                            f.write(f"  ```\n")                            f.write(f"  {issue['content']}\n")                            f.write(f"  ```\n")                            f.write(f"  > Match: `{issue['match']}`\n\n")                    if result['playwright_issues']:                        f.write(f"#### âš ï¸ Playwright Antipatterns ({len(result['playwright_issues'])})\n\n")                        for issue in result['playwright_issues']:                            f.write(f"- **Line {issue['line']}:** {issue['type']}\n")                            f.write(f"  ```\n")                            f.write(f"  {issue['content']}\n")                            f.write(f"  ```\n\n")                    if result['bad_practices']:                        f.write(f"#### ğŸ“‹ Bad Practices ({len(result['bad_practices'])})\n\n")                        for issue in result['bad_practices']:                            f.write(f"- **Line {issue['line']}:** {issue['type']}\n")                            f.write(f"  ```\n")                            f.write(f"  {issue['content']}\n")                            f.write(f"  ```\n\n")                    f.write(f"---\n\n")        # Save latest.md symlink/copy        latest_md = f"{output_dir}/latest.md"        latest_json = f"{output_dir}/latest.json"        # Copy to latest files        with open(md_file, 'r', encoding='utf-8') as src:            with open(latest_md, 'w', encoding='utf-8') as dst:                dst.write(src.read())        with open(json_file, 'r', encoding='utf-8') as src:            with open(latest_json, 'w', encoding='utf-8') as dst:                dst.write(src.read())        return json_file, md_file    def print_report(self, results: List[Dict]):        """Print audit report"""        print("\n" + "="*80)        print("ğŸ” AI GUARD - TEST FILE AUDIT REPORT")        print("="*80 + "\n")        if not results:            print("âœ… No issues found! Your tests look clean.")            return True        total_secrets = 0        total_bad_practices = 0        total_playwright_issues = 0        for result in results:            file_path = result['file']            secrets = result['secrets']            bad_practices = result['bad_practices']            playwright_issues = result['playwright_issues']            if not (secrets or bad_practices or playwright_issues):                continue            print(f"\nğŸ“„ File: {file_path}")            print(f"   Lines: {result['line_count']}")            print("-" * 80)            # Report secrets (CRITICAL)            if secrets:                print("\nğŸš¨ CRITICAL - SECRETS DETECTED:")                for issue in secrets:                    print(f"   Line {issue['line']}: {issue['type']}")                    print(f"   â†’ {issue['content']}")                    print(f"   âš ï¸  Match: {issue['match']}\n")                total_secrets += len(secrets)            # Report Playwright antipatterns            if playwright_issues:                print("\nâš ï¸  PLAYWRIGHT ANTIPATTERNS:")                for issue in playwright_issues:                    print(f"   Line {issue['line']}: {issue['type']}")                    print(f"   â†’ {issue['content']}\n")                total_playwright_issues += len(playwright_issues)            # Report bad practices            if bad_practices:                print("\nğŸ“‹ BAD PRACTICES / TECHNICAL DEBT:")                for issue in bad_practices:                    print(f"   Line {issue['line']}: {issue['type']}")                    print(f"   â†’ {issue['content']}\n")                total_bad_practices += len(bad_practices)        # Summary        print("\n" + "="*80)        print("ğŸ“Š SUMMARY")        print("="*80)        print(f"Files scanned: {len(results)}")        print(f"ğŸš¨ Critical secrets: {total_secrets}")        print(f"âš ï¸  Playwright antipatterns: {total_playwright_issues}")        print(f"ğŸ“‹ Bad practices: {total_bad_practices}")        print(f"\nTotal issues: {total_secrets + total_bad_practices + total_playwright_issues}")        if total_secrets > 0:            print("\nâŒ AUDIT FAILED - Secrets detected!")            return False        elif total_playwright_issues > 0 or total_bad_practices > 0:            print("\nâš ï¸  WARNINGS - Consider addressing these issues")            return True        else:            print("\nâœ… AUDIT PASSED")            return Truedef main():    auditor = TestAuditor()    # Default directories to scan    test_dirs = [        'tests',        'microservices/cart-service/src',        'microservices/product-service/src',        'microservices/order-service/src',        'microservices/ai-service/src',    ]    # Check for specific file argument    if len(sys.argv) > 1:        target = sys.argv[1]        if os.path.isfile(target):            print(f"ğŸ” Scanning file: {target}")            result = auditor.scan_file(target)            results = [result] if any([result['secrets'], result['bad_practices'], result['playwright_issues']]) else []        elif os.path.isdir(target):            print(f"ğŸ” Scanning directory: {target}")            results = auditor.scan_directory(target)        else:            print(f"âŒ Invalid path: {target}")            sys.exit(1)    else:        # Scan all test directories        print("ğŸ” Scanning test directories...")        results = []        for test_dir in test_dirs:            if os.path.exists(test_dir):                print(f"   â†’ {test_dir}")                dir_results = auditor.scan_directory(test_dir)                results.extend(dir_results)    # Print report to console    success = auditor.print_report(results)    # Save results to files    if results or not results:  # Always save, even if no issues        json_file, md_file = auditor.save_results(results if results else [])        print("\n" + "="*80)        print("ğŸ’¾ AUDIT RESULTS SAVED")        print("="*80)        print(f"ğŸ“„ Markdown Report: {md_file}")        print(f"ğŸ“Š JSON Report: {json_file}")        print(f"ğŸ“Œ Latest Report: audit/latest.md")        print(f"ğŸ“Œ Latest JSON: audit/latest.json")    sys.exit(0 if success else 1)if __name__ == "__main__":    main()